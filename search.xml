<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
    
    <entry>
      <title><![CDATA[Tomcat集群（linux）]]></title>
      <url>https://shaojiaming.github.io/2017/03/17/Tomcat%E9%9B%86%E7%BE%A4/</url>
      <content type="html"><![CDATA[<p>本文在red hat下进行搭建的，参考网上的搭建步骤结合自己的实际操作，从系统安装到最终的搭建进行详细的说明。<br><a id="more"></a></p>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><pre><code>一.    前期准备    
二.    环境安装    
    1.    安装gcc 和g++    
    2.    安装apache    
    3.    配置java运行环境变量    
    4.    配置tomcat    
    5.    配置JK连接器    
三.    测试apache负载均衡是否生效    
</code></pre><h2 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h2><h3 id="安装介质"><a href="#安装介质" class="headerlink" title="安装介质 :"></a>安装介质 :</h3><table>
<thead>
<tr>
<th>工具</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>rhel-server-6.4-x86_64-dvd.iso</td>
<td>RedHat Enterprise Linux 6.4 x86 64bit</td>
</tr>
<tr>
<td>tomcat-connectors-1.2.41.tar.gz</td>
<td>Tomcat负载均衡模块</td>
</tr>
<tr>
<td>httpd-2.4.10.tar.gz</td>
<td>Apache源码包</td>
</tr>
<tr>
<td>apr-1.5.1.tar.gz</td>
<td>Apache依赖包</td>
</tr>
<tr>
<td>apr-util-1.5.1.tar.gz</td>
<td>Apache依赖包</td>
</tr>
<tr>
<td>pcre-8.32.tar.gz</td>
<td>Apache依赖包</td>
</tr>
<tr>
<td>Tomcat 7.0.75</td>
<td>Tomcat安装包</td>
</tr>
<tr>
<td>jdk-7u79-linux-x64.tar.gz</td>
<td>Java运行环境</td>
</tr>
</tbody>
</table>
<h2 id="环境安装"><a href="#环境安装" class="headerlink" title="环境安装"></a>环境安装</h2><h3 id="关闭linux-selinux"><a href="#关闭linux-selinux" class="headerlink" title="关闭linux selinux"></a>关闭linux selinux</h3><p>1、    root用户登录<br>2、    cd /etc/selinux<br>3、    vim config   设置selinux=disabled<br>Selinux 解释：<br>SELinux是一种基于域-类型 模型（domain-type）的强制访问控制（MAC）安全系统，它由NSA编写并设计成内核模块包含到内核中。</p>
<h3 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h3><p>1、    运行 service iptables status  查看防火墙状态<br>2、    如果提示防火墙未关闭请执行以下操作<br>3、    chkconfig iptables off  (关闭防火墙-永久生效)<br>4、    chkconfig iptables on  (打开防火墙-永久生效)<br>5、    重启服务器 reboot</p>
<h3 id="安装gcc-和g"><a href="#安装gcc-和g" class="headerlink" title="安装gcc 和g++"></a>安装gcc 和g++</h3><p>挂载光驱</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"># mkdir /mnt/cdrom</div><div class="line"># mount -o loop -t iso9660 /opt/software/rhel-server-6.4-x86_64-dvd.iso /mnt/cdrom/</div><div class="line"># rpm -ivh /mnt/cdrom/Packages/yum-3.2.29-40.el6.noarch.rpm</div><div class="line"># vi /etc/yum.repos.d/local.repo</div><div class="line">[rhel-Server]</div><div class="line">name=Server</div><div class="line">baseurl=file:///mnt/cdrom/Server</div><div class="line">enabled=1</div><div class="line">gpgcheck=0</div><div class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release</div><div class="line"># cat /etc/yum.repos.d/local.repo</div><div class="line"># yum clean all</div><div class="line"># yum list gcc*</div><div class="line"># yum install gcc.x86_64</div><div class="line"># yum install gcc-c++.x86_64</div></pre></td></tr></table></figure>
<p>验证<br> <img src="/images/1489737763633.png" alt="&quot;图一&quot;"></p>
<h3 id="安装apache-官网：http-httpd-apache-org"><a href="#安装apache-官网：http-httpd-apache-org" class="headerlink" title="安装apache(官网：http://httpd.apache.org/)"></a>安装apache(官网：<a href="http://httpd.apache.org/" target="_blank" rel="external">http://httpd.apache.org/</a>)</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">中间件存储路径/usr/local/</div><div class="line">Apache安装路径/usr/local/web/apache</div><div class="line"><span class="selector-id">#tar</span> -zxvf httpd-<span class="number">2.4</span>.<span class="number">10</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></div><div class="line"><span class="selector-id">#tar</span> -zxvf pcre-<span class="number">8.32</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></div><div class="line"><span class="selector-id">#tar</span> -zxvf apr-<span class="number">1.5</span>.<span class="number">1</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></div><div class="line"><span class="selector-id">#tar</span> -zxvf apr-util-<span class="number">1.5</span>.<span class="number">1</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></div><div class="line"></div><div class="line"><span class="selector-id">#cd</span> pcre-<span class="number">8.32</span></div><div class="line">#./configure --prefix=/usr/local/pcre</div><div class="line"><span class="selector-id">#make</span></div><div class="line"><span class="selector-id">#make</span> install</div><div class="line"></div><div class="line"><span class="selector-id">#cd</span> ../apr-<span class="number">1.5</span>.<span class="number">1</span></div><div class="line">#./configure --prefix=/usr/local/apr</div><div class="line"><span class="selector-id">#make</span></div><div class="line"><span class="selector-id">#make</span> install</div><div class="line"></div><div class="line"><span class="selector-id">#cd</span> ../apr-util-<span class="number">1.5</span>.<span class="number">1</span></div><div class="line">#./configure --prefix=/usr/local/apr-util --with-apr=/usr/local/apr</div><div class="line"><span class="selector-id">#make</span></div><div class="line"><span class="selector-id">#make</span> install</div><div class="line"></div><div class="line"><span class="selector-id">#cd</span> ../httpd-<span class="number">2.4</span>.<span class="number">10</span></div><div class="line">#./configure --prefix=/usr/local/web/apache --enable-so --enable-mods-shared=most --with-mpm=worker --enable-proxy --enable-rewrite --with-pcre=/usr/local/pcre --with-apr=/usr/local/apr --with-apr-util=/usr/local/apr-util</div><div class="line"><span class="selector-id">#make</span></div><div class="line"><span class="selector-id">#make</span> install</div><div class="line"></div><div class="line">启动apache</div><div class="line">#/usr/local/web/apache/apachectl start</div></pre></td></tr></table></figure>
<p>在本地打开浏览器，访问<a href="http://127.0.0.1" target="_blank" rel="external">http://127.0.0.1</a><br>如果出现“It Works!”则表示启动成功了</p>
<h3 id="配置java运行环境变量"><a href="#配置java运行环境变量" class="headerlink" title="配置java运行环境变量"></a>配置java运行环境变量</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="selector-id">#mkdir</span> /usr/java</div><div class="line"><span class="selector-id">#tar</span> –zxvf  jdk-<span class="number">7</span>u79-linux-x64<span class="selector-class">.tar</span><span class="selector-class">.gz</span>  /usr/java</div><div class="line"><span class="selector-id">#vi</span> /etc/profile</div><div class="line">export JAVA_HOME=/usr/java/jdk1.<span class="number">7.0</span>_05</div><div class="line">export CLASSPATH=.:<span class="variable">$JAVA_HOME</span>/lib/<span class="selector-tag">dt</span><span class="selector-class">.jar</span>:<span class="variable">$JAVA_HOME</span>/lib/tools<span class="selector-class">.jar</span></div><div class="line">export PATH=<span class="variable">$PATH</span>:<span class="variable">$JAVA_HOME</span>/bin</div><div class="line">export JAVA_HOME CLASSPATH PATH</div><div class="line"><span class="selector-id">#source</span> /etc/profile</div></pre></td></tr></table></figure>
<p>验证:输入<br>javac<br>java –version</p>
<h3 id="配置tomcat"><a href="#配置tomcat" class="headerlink" title="配置tomcat"></a>配置tomcat</h3><p>1.将tomcat分别放到两个文件夹下<br>2.修改service.xml文件的port<br>3.修改两台server的端口<br>4.添加jvmRoute(配置另一台时jvmRoute=”s2”)<br><code>&lt;Engine defaultHost=&quot;localhost&quot; name=&quot;Catalina&quot; jvmRoute=&quot;tomcat1&quot;&gt;</code><br>5.解开注释<br><code>&lt;Cluster className=&quot;org.apache.catalina.ha.tcp.SimpleTcpCluster&quot;/&gt;</code><br>6.启动两台tomcat 看是否能访问到对应的测试页面</p>
<h3 id="配置JK连接器"><a href="#配置JK连接器" class="headerlink" title="配置JK连接器"></a>配置JK连接器</h3><p>1.编译jk</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"># cd tomcat-connectors-1.2.32-src </div><div class="line"># cd native/</div><div class="line"># ./configure --with-apxs=/usr/local/web/apache/bin/apxs </div><div class="line"># make  </div><div class="line"># ls</div><div class="line"># cd apache-2.0/</div><div class="line"># ls </div><div class="line">bldjk54.qclsrc  Makefile.apxs     mod_jk.a    mod_jk.lo</div><div class="line">bldjk.qclsrc    Makefile.apxs.in  mod_jk.c    mod_jk.o</div><div class="line">config.m4       Makefile.in       mod_jk.dsp  mod_jk.so</div><div class="line">Makefile        Makefile.vc       mod_jk.la   NWGNUmakefile</div><div class="line"># sudo cp ./mod_jk.so /usr/local/web/apache/modules/</div></pre></td></tr></table></figure>
<p>2.修改apache的httpd.conf文件<br>添加</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">LoadModule jk_module modules/mod_jk<span class="selector-class">.so</span></div><div class="line">&lt;IfModule jk_module&gt;</div><div class="line">  JkWorkersFile conf/workers<span class="selector-class">.properties</span></div><div class="line">  JkLogFile logs/mod_jk<span class="selector-class">.log</span></div><div class="line">  JkLogLevel warn</div><div class="line">  JkMount <span class="comment">/*.jsp loadBalanceServers</span></div><div class="line">&lt;/IfModule&gt;</div></pre></td></tr></table></figure>
<p>3.在conf文件夹下面添加workers.properties文件<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">--------------------------------------------------------------------------------------------------------------------------</div><div class="line">#</div><div class="line"># workers.properties</div><div class="line">#</div><div class="line"># list the workers by name</div><div class="line">worker.list=loadBalanceServers</div><div class="line"># localhost server 1</div><div class="line"># ------------------------</div><div class="line">worker.s1.port=6009 //6080端口转发port</div><div class="line">worker.s1.host=localhost  #tomcat的主机地址，如不为本机，请填写ip地址</div><div class="line">worker.s1.type=ajp13   #ajp13 端口号，在tomcat下server.xml配置,默认8009</div><div class="line">worker.s1.lbfactor=10   #server的加权比重，值越高，分得的请求越多</div><div class="line"># localhost server 2</div><div class="line"># ------------------------</div><div class="line">worker.s2.port=7009 //7080端口转发port</div><div class="line">worker.s2.host=localhost  #tomcat的主机地址，如不为本机，请填写ip地址</div><div class="line">worker.s2.type=ajp13  #ajp13 端口号，在tomcat下server.xml配置,默认8009</div><div class="line">worker.s2.lbfactor=10  #server的加权比重，值越高，分得的请求越多</div><div class="line"></div><div class="line">worker.loadBalanceServers.type=lb</div><div class="line">worker.loadBalanceServers.balanced_workers=s1,s2  #  #controller控制的tomcat的名称指定分担请求的tomcat由tomcat中的server.xml中设值</div><div class="line">worker.loadBalanceServers.sticky_session=true  #会话是否有粘性，false表示无粘性，同一个会话的请求会到不同的tomcat中处理</div><div class="line"></div><div class="line"># worker.controller.retries=3  #请求失败以后重试次数</div><div class="line"># worker.controller.sticky_session_force=false #当一个节点崩了，如果设置为true，那么服务器返回500错误给客户端，如果设置为false,则转发给其他的tomcat，但是会丢失回话信息</div></pre></td></tr></table></figure></p>
<p>4.重启apache</p>
<h2 id="测试apache负载均衡是否生效"><a href="#测试apache负载均衡是否生效" class="headerlink" title="测试apache负载均衡是否生效"></a>测试apache负载均衡是否生效</h2><ol>
<li>创建两个项目test</li>
<li>在index.jsp中分别添加如下代码<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;%session.setAttribute("id","123");%&gt;</div><div class="line">&lt;%=session.getAttribute("id")%&gt;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>分别重启两台tomcat服务器, 在两台浏览器中输入<a href="http://10.46.2.10/test/index.jsp" target="_blank" rel="external">http://10.46.2.10/test/index.jsp</a></p>
]]></content>
      
        <categories>
            
            <category> 力量之源 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> java </tag>
            
            <tag> tomcat </tag>
            
            <tag> apache </tag>
            
        </tags>
        
    </entry>
    
  
  
</search>
